/*!
 * maptalks.odline v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@^0.23.1 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function o(t,e){for(var o=Object.getOwnPropertyNames(e),i=0;i<o.length;i++){var n=o[i],r=Object.getOwnPropertyDescriptor(e,n);r&&r.configurable&&void 0===t[n]&&Object.defineProperty(t,n,r)}return t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):o(t,e))}function a(t,e,o,i){var n=1-i;return n*(n*t+2*i*e)+i*i*o}var s={animation:!0,random:!1,duration:6e3,curveness:.2,trail:20,globalCompositeOperation:"lighter"},p={lineColor:"#000",lineWidth:2},d=function(t){function o(e,r,a){i(this,o),r&&!Array.isArray(r)&&(r=[r]);var s=n(this,t.call(this,e,a));return s.setData(r),s}return r(o,t),o.prototype.getData=function(){return this._data},o.prototype.setData=function(t){return this._data=t,this.getMap()&&(this._prepareData(),this._getRenderer()&&this._getRenderer().render()),this},o.prototype.identify=function(){return null},o.prototype.getParticles=function(t){this._animStartTime||(this._animStartTime=Date.now());for(var o=this.getMap(),i=o.getScale(),n=(t-this._animStartTime)%this.options.duration/this.options.duration,r=[],s={},p=void 0,d=void 0,u=void 0,l=void 0,h=void 0,c=void 0,f=void 0,y=0,m=this._dataToDraw.length;y<m;y++)this.options.random&&(n=(t-this._animStartTime-this._dataToDraw[y].time)%this.options.duration/this.options.duration)<0&&(n=0),n>0&&(p=this._dataToDraw[y].points,l=this._data[y].symbol||s,h=p[0],c=p[1],p[2]?(f=p[2],d=a(h.x,f.x,c.x,n),u=a(h.y,f.y,c.y,n)):(d=h.x+n*(c.x-h.x),u=h.y+n*(c.y-h.y)),r.push({point:o._pointToContainerPoint(new e.Point(d,u)._multi(1/i)),r:(l.lineWidth||3)/2,color:l.lineColor}));return r},o.prototype.draw=function(e){return this._dataToDraw||this._prepareData(),this.options.animation?t.prototype.draw.apply(this,arguments):(this._drawLines(e),this)},o.prototype.onConfig=function(){this._getRenderer()&&this._getRenderer().render()},o.prototype.onRemove=function(){delete this._dataToDraw},o.prototype.toJSON=function(t){t||(t={});var o={type:this.getJSONType(),id:this.getId(),options:this.config()},i=this.getData();if(t.clipExtent){for(var n=new e.Extent(t.clipExtent),r=[],a=0,s=i.length;a<s;a++)n.contains(new e.Coordinate(i[a][0],i[a][1]))&&r.push(i[a]);o.data=r}else o.data=i;return o},o.fromJSON=function(t){return t&&t.type===this.getJSONType()?new o(t.id,t.data,t.options):null},o.prototype._precise=function(t){return e.Util.round(100*t)/100},o.prototype._drawLines=function(t){if(this._dataToDraw){var e=this.getMap(),o=e.getScale(),i={},n=this.options.symbol||p,r=void 0,a=void 0,s=void 0,d=void 0,u=void 0;t.lineCap="round";for(var l=0,h=this._dataToDraw.length;l<h;l++)r=this._dataToDraw[l].points,a=this._data[l].symbol||i,t.strokeStyle=a.lineColor||n.lineColor||"rgba(255, 255, 255, 0.01)",t.lineWidth=a.lineWidth||n.lineWidth||1,t.beginPath(),s=e._pointToContainerPoint(r[0].multi(1/o)),t.moveTo(s.x,s.y),d=e._pointToContainerPoint(r[1].multi(1/o)),r[2]?(u=e._pointToContainerPoint(r[2].multi(1/o)),t.quadraticCurveTo(u.x,u.y,d.x,d.y)):t.lineTo(d.x,d.y),t.stroke()}},o.prototype._prepareData=function(){if(this._data){for(var t=this.options.curveness,o=this.getMap(),i=o.getMaxNativeZoom(),n=[],r=void 0,a=void 0,s=0,p=this._data.length;s<p;s++){r=o.coordinateToPoint(new e.Coordinate(this._data[s].coordinates[0]),i),a=o.coordinateToPoint(new e.Coordinate(this._data[s].coordinates[1]),i);var d=[r,a];if(t){var u=a.distanceTo(r),l=r.substract(a)._unit()._perp(),h=r.add(a)._multi(.5),c=t*u,f=new e.Point(h.x+c*l.x,h.y+c*l.y);d.push(f)}n.push({points:d,time:Math.random()*this.options.duration})}this._dataToDraw=n}},o}(e.ParticleLayer);d.mergeOptions(s),d.registerJSONType("ODLineLayer"),t.ODLineLayer=d,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.odline v0.1.0, requires maptalks@^0.23.1.")});